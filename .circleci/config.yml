### =============================================================
### This configuration file is used by CircleCI build server
### https://circleci.com/docs/config-sample
### =============================================================
version: 2
jobs:
  # using tox
  toxify:

      docker:
        - image: python:3.8

      steps:
        - checkout
        - run:
            name: tox build
            command: |
              pip install tox
              tox -e py37 -v -- --cov=demisto_sdk --cov-report=html
              tox -e py38 -v
              echo "Parameters: FAKE_MASTER: $FAKE_MASTER"
        - run:
            name: pre-commit
            command: |
              . .tox/py37/bin/activate
              pre-commit --version
              pre-commit run -a
              deactivate
        - store_artifacts:
            path: coverage_html_report
        - run:
            name: coveralls upload
            command: |
              pip install coveralls
              coveralls
        - run:
            name: test validate files and yaml
            command: |
              . .tox/py37/bin/activate

              git clone https://github.com/demisto/content.git
              cd content

              if [[ $CIRCLE_BRANCH != master && $FAKE_MASTER != true ]]; then
                demisto-sdk validate -i Packs/Gmail
                exit 0
              fi

              chmod +x ./Tests/scripts/validate.sh
              ./Tests/scripts/validate.sh
        - run:
            name: test create content artifacts
            command: |
              . .tox/py37/bin/activate

              if [[ $CIRCLE_BRANCH != master && $FAKE_MASTER != true ]]; then
                echo "Skipping creating content artifacts on non master branch"
                exit 0
              fi
              demisto-sdk create-content-artifacts -a ./tmp
        - run:
            name: test create ID set
            command: |
              . .tox/py37/bin/activate

              if [[ $CIRCLE_BRANCH != master && $FAKE_MASTER != true ]]; then
                  echo "Skipping creating ID set on non master branch"
                  exit 0
              fi
              demisto-sdk create-id-set -o ./Tests/id_set.json
        - run:
            name: deploy
            command: |
              ./demisto_sdk/utils/deploy.sh
workflows:
  version: 2
  build_and_release:
    jobs:
      - toxify:
          filters:
            tags:
              only: /^v\d+\.\d+\.\d+$/
