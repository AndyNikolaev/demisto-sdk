commonfields:
  id: MITREIndicatorsByOpenIncidents
  version: -1
name: MITREIndicatorsByOpenIncidents
fromversion: 5.5.0
script: >2



  res = demisto.executeCommand("demisto-api-post",
                               {
                                   "uri": "statistics/widgets/query",
                                   "body":
                                       json.dumps(
                                           {"dataType": "indicators",
                                            "widgetType": "bar",
                                            "query": "type:\"MITRE ATT\u0026CK\" and investigationsCount:\u003e0",
                                            "params": {
                                                "groupBy": [
                                                    "name"
                                                ],
                                                "keys": [
                                                    "sum|investigationsCount"
                                                ]
                                            }
                                            })
                               })

  indicators = []

  for v in res[0]['Contents']['response']:
      value = v["name"]
      indicator_res = demisto.executeCommand("getIndicator", {"value": value})[0]['Contents']
      for ind in indicator_res:
          indicators.append({
              'Value': ind['value'],
              'Name': ind['CustomFields']['mitrename'],
              'Phase Name': ind['CustomFields']['mitrekillchainphases'][0]['phase_name'],
              'Description': ind['CustomFields']['mitredescription'],

          })

  temp = tableToMarkdown('MITRE ATT&CK techniques by open Incidents', indicators,
                         headers=['Value', 'Name', 'Phase Name', 'Description'])
  return_outputs(temp)
type: python
tags:
- widget
comment: "This is a widget script returning MITRE indicators information for top indicators shown in incidents."
enabled: true
scripttarget: 0
subtype: python3
runonce: false
dockerimage: demisto/python3:3.8.3.9324
runas: DBotWeakRole
tests:
- No test.
